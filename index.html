<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple markers</title>
    <link rel="stylesheet" type="text/css" href="https://googledrive.com/host/0B17VEgsJHrneY2Z1VXl0YTluWmc" media="screen"/>
    <style>
      .controls {
        margin-top: 16px;
        border: 1px solid transparent;
        border-radius: 2px 0 0 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        height: 32px;
        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
      #pac-input {
        background-color: #fff;
        padding: 0 11px 0 13px;
        width: 400px;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        text-overflow: ellipsis;
      }
      #pac-input:focus {
        border-color: #4d90fe;
        margin-left: -1px;
        padding-left: 14px;  /* Regular padding-left + 1. */
        width: 401px;
      }
      .pac-container {
        font-family: Roboto;
      }
      #type-selector {
        color: #fff;
        background-color: #4d90fe;
        padding: 5px 11px 0px 11px;
      }
      #type-selector label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
      #Exa1 li{
        float:right;
        padding:20px;
        color:#FFFFFF;
        background-color:#888888;
        margin:1px;
        list-style-type:none;
      }
}
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>
    <script>
    
    //取得網址列參數
    function  request(paramName)  
    {  
        //获取URL的字符串  
        var sSource=String(window.document.location);  
        var sName= paramName;    
        var sReturn="";     
        var sQUS="?";     
        var sAMP="&";     
        var sEQ="=";     
        var iPos;  
      
        //获取sSource中的"?"，无则返回 -1  
        iPos=sSource.indexOf(sQUS);  
        if(iPos==-1)   
            return;   
          
        //汲取参数，从iPos位置到sSource.length-iPos的位置，  
        //若iPos = -1，则：从-1 到 sSource.length+1  
        var strQuery=sSource.substr(iPos,sSource.length-iPos);   
      
        // alert(strQuery);   
        //先全部转换为小写  
        var   strLCQuery = strQuery.toLowerCase();     
        var   strLCName  = sName.toLowerCase();   
      
        //从子字符串strLCQuery中查找“?”、参数名，以及“=”，即“?参数名=”  
        iPos   = strLCQuery.indexOf(sQUS + strLCName + sEQ);  
        //alert(iPos);  
        //如果不存在  
        if(iPos == -1)     
        {     
            //继续查找可能的后一个参数，即带“&参数名=”  
            iPos = strLCQuery.indexOf(sAMP + strLCName + sEQ);     
        }  
      
        //判断是否存在参数  
        if(iPos != -1)  
        {      
            sReturn = strQuery.substr(iPos + sName.length + 2,strQuery.length-(iPos + sName.length + 2));     
            var iPosAMP = sReturn.indexOf(sAMP);     
            if (iPosAMP == -1)  
            {  
                return   sReturn;     
            }  
            else  
            {     
                sReturn = sReturn.substr(0,iPosAMP);     
            }     
        }  
        return   sReturn;   
    }
    
    
   
    
    var map;
    var infowindow = new google.maps.InfoWindow({ });
    var s_time     = [];
    var s_location = [];
    var s_seq      = [];
    var s_lat      = [];
    var s_lng      = [];
    var s_remark   = [];
    var s_tran     = [];
    var s_kind     = [];
    var s_day      = "";
    var s_type     = "";
    if(request("day_tag") != null ) s_day = request("day_tag");
    if(request("eat_tag") != null ) s_type= request("eat_tag");
    
    //http://imgur.com/9ltSWci
    
    
    //travel
    var image = {
      url: 'http://i.imgur.com/YRCzrue.png',
      size: new google.maps.Size(32, 37),
      origin: new google.maps.Point(0,0),
      anchor: new google.maps.Point(16, 0)
    };
    
    //food
    var image3 = {
      url: 'http://i.imgur.com/cJoDtNZ.png',
      size: new google.maps.Size(32, 37),
      origin: new google.maps.Point(0,0),
      anchor: new google.maps.Point(16, 0)
    };
        
    
    var shape = {
        coords: [4, 3, 4, 29, 9, 30, 16 , 34, 29,29,29,4],
        type: 'poly'
    };
    function test(json) {
      var a = json.feed.entry.length;
      var j = -1;
      for (var i = 0; i < a; i++) {
        //b[i] = json.feed.entry[i].content.$t
        var c = json.feed.entry[i].title.$t.substring(0,1)
        if(c=='A'){
        	j++;
          s_time[j] = json.feed.entry[i].content.$t;
        }
        if(c=='B')
          s_location[j] = json.feed.entry[i].content.$t;
        if(c=='C')
          s_seq[j] = json.feed.entry[i].content.$t;
        if(c=='D')
          s_lat[j] = json.feed.entry[i].content.$t;
        if(c=='E')
          s_lng[j] = json.feed.entry[i].content.$t;
        if(c=='F')
          s_tran[j] = json.feed.entry[i].content.$t;
        if(c=='G')
          s_remark[j] = json.feed.entry[i].content.$t;
        if(c=='H')
          s_kind[j] = json.feed.entry[i].content.$t;
      }
      //document.write("<br>TIME=========="+s_time[1]);
      //document.write("<br>s_location=========="+s_location[1]);
      //document.write("<br>seq=========="+s_seq[1]);
      //document.write("<br>lat=========="+s_lat[1]);
      //document.write("<br>lng=========="+s_lng[1]);
      //document.write("<br>s_time.length==="+s_time.length);
    }
	
    function initialize() 
    {
      var mapOptions = {
        zoom: 11,
        center:new google.maps.LatLng(35.1626054,129.1168086)
      }
      map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions,{
      	mapTypeId: google.maps.MapTypeId.ROADMAP,
      });
      document.getElementById("seq").value=s_time.length+1;
      setMarkers(map);
//SEARCH BOX
      // Create the search box and link it to the UI element.   
      var markers = [];
      var input = (document.getElementById('pac-input'));
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
      
      var searchBox = new google.maps.places.SearchBox((input));
      // Listen for the event fired when the user selects an item from the
      // pick list. Retrieve the matching places for that item.
      google.maps.event.addListener(searchBox, 'places_changed', function() {
        var places = searchBox.getPlaces();
      
        if (places.length == 0) {
          return;
        }
        for (var i = 0, marker2; marker2 = markers[i]; i++) {
          marker2.setMap(null);
        }
      
        // For each place, get the icon, place name, and location.
        markers = [];
        var bounds = new google.maps.LatLngBounds();
        
        for (var i = 0, place; place = places[i]; i++) {
          var image2 = {
            url: 'http://i.imgur.com/lTKFEwA.png',
            size: new google.maps.Size(32, 37),
            origin: new google.maps.Point(0,0),
            anchor: new google.maps.Point(16, 0)
          };
          // Create a marker for each place.
          var marker2 = new google.maps.Marker({
            map: map,
            icon: image2,
            title: place.name,
            position: place.geometry.location
          });
          //alert(place.geometry.location.lat());
          markers.push(marker2);
          bounds.extend(place.geometry.location);
          document.getElementById("location").value = document.getElementById("pac-input").value;
          document.getElementById("lat").value = place.geometry.location.lat();
          document.getElementById("lng").value = place.geometry.location.lng();
        }
        map.fitBounds(bounds);
      });
      
      // Bias the SearchBox results towards places that are within the bounds of the
      // current map's viewport.
      google.maps.event.addListener(map, 'bounds_changed', function() {
        var bounds = map.getBounds();
        searchBox.setBounds(bounds);
      });
//SEARCH BOX END
    }
    
    function setMarkers(map) 
    {
    	var marker;
      for (var i = 1; i < s_time.length; i++) 
      {
        if((s_day=="" || s_day==s_kind[i]) &&
           (s_type=="" || s_type==s_tran[i]))
        {
        	
        	var myLatLng = new google.maps.LatLng(s_lat[i], s_lng[i]);
        	
        	if(s_tran[i]=="B")
        	{
            marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                icon: image3,
                shape: shape,
                title: s_location[i],
                zIndex: i
            });
          }else{
            marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                icon: image,
                shape: shape,
                title: s_location[i],
                zIndex: i
            });
          }
          attachSecretMessage(map,marker, s_location[i]);
        }
      }
    }
    function attachSecretMessage(map,marker,ok) 
    {
      infowindow = new google.maps.InfoWindow(
          { content: ok ,
            maxwidth:500
          });
      google.maps.event.addListener(marker, 'click', function() {
      	if(infowindow!=null)
      	{
      	  infowindow.close();
          infowindow = new google.maps.InfoWindow(
          { content: ok ,
            maxwidth:500
          });
      	}else{
          infowindow = new google.maps.InfoWindow(
          { content: ok ,
            maxwidth:500
          });
      	}
      	infowindow.open(map,marker);
      });
    }
    function searchmap(lat,lng,i)
    { 
      var test = s_location[i];
      var myLatLng = new google.maps.LatLng(lat, lng);
      //var marker = new google.maps.Marker({
      //   position: myLatLng,
      //   map:map
      //});
      map.panTo( myLatLng );
      //map.setZoom(13);
      //map.centerAndZoom(myLatLng,15);
      infowindow.close();
      infowindow = new google.maps.InfoWindow(
      { content: test ,
        position: myLatLng,
        map:map,
        maxwidth:500
      });
      infowindow.open(map);
    }
    
    function resetmap()
    {
      var myLatLng = new google.maps.LatLng(35.1626054,129.1168086);
      var marker = new google.maps.Marker({
           position: myLatLng,
      });
      map.panTo( myLatLng );
      map.setZoom(11);
      
      infowindow.close();
    }
    
    function showmap(kind)
    {
    	for (var i = 1; i < s_time.length; i++) 
        {
            if(s_kind[i]==kind)
            {
                if(s_tran[i]=="A")
                    document.write("<a href='javascript:searchmap("+s_lat[i]+", "+s_lng[i]+","+i+")'  style='text-decoration:none;color:#666666;font-family:微軟正黑體;' ><span style='width: 130px;display: inline-block;background-color:#CCEEFF;padding:2px;margin:4px;'>"+s_location[i]+"</span></a>");
                else
                    document.write("<a href='javascript:searchmap("+s_lat[i]+", "+s_lng[i]+","+i+")'  style='text-decoration:none;color:#666666;font-family:微軟正黑體;' ><span style='width: 130px;display: inline-block;background-color:#FFF0F5;padding:2px;margin:4px;'>"+s_location[i]+"</span></a>");
            }
    	}
    }
    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    <script src="https://spreadsheets.google.com/feeds/cells/1PALv35hqLAdXcBDHneaE6IzvQnNNl3QEtbJ6H5jKr48/1/public/basic?alt=json-in-script&callback=test"></script>
  </head>
  <body >
  <div style="width: 1400px;height: 800px">
      <input id="pac-input" class="controls" type="text" placeholder="Search Box">

      <div name="map-canvas" id="map-canvas" style="width: 890px; height: 800px;float:left;" ></div>
      <div style="width: 500px;float:right">    
        <div id="tabsF" >
          <ul id="Exa1">
            <li><a href="javascript://" onclick="loadTab(this,2);" style='text-decoration:none;color:#FFFFFF;font-family:微軟正黑體;' >查詢維護</a></li>
            <li id="current"><a href="javascript://" onclick="loadTab(this,1);" style='text-decoration:none;color:#FFFFFF;font-family:微軟正黑體;' >標籤</a></li>
          </ul>
          <a href="javascript:resetmap()"                style='text-decoration:none;font-family:微軟正黑體;padding:5px;' >RESET</a>
          <a href='http://goo.gl/kemzsb' target='_blank' style='text-decoration:none;font-family:微軟正黑體;padding:5px;' >資料庫1</a>
          <a href='https://goo.gl/rVWUoU' target='_blank'style='text-decoration:none;font-family:微軟正黑體;padding:5px;' >行程表</a>
        </div>
      	<div id="tabsC">
      		<div id="S1" style="display:inline;">

               <table width=500px>
               	<tr>
               		<td style='border-right:1px solid #666666;border-bottom:1px solid #666666;font-family:微軟正黑體;color:#FFFFFF;padding:5px;' bgcolor=#008B8B>
               			第幾天
               		</td>
               		<td>
               		  <select id="day_tag" name="day_tag">
               		  	<option value="">ALL</option>
               		  	<option value="1">DAY1</option>
               		  	<option value="2">DAY2</option>
               		  	<option value="3">DAY3</option>
               		  	<option value="4">DAY4</option>
               		  	<option value="5">DAY5</option>
               		  	<option value="6">DAY6</option>
               		  	<option value="7">DAY7</option>
               		  </select>
               		</td>  
               		<td style='border-right:1px solid #666666;border-bottom:1px solid #666666;font-family:微軟正黑體;color:#FFFFFF;padding:5px;' bgcolor=#008B8B>
               			類別
               		</td>
               		<td>
               		  <select id="eat_tag" name="eat_tag">
               		  	<option value="">ALL </option>
               		  	<option value="A">景點 </option>
               		  	<option value="B">餐廳 </option>
               		  </select>
               		</td> 
               		<td>
               			<input type="button" id="button1" name="button1" value="查詢" onclick="gotosearch()">
               		</td>
               	</tr>
<tr><td colspan=5><br></td></tr>  
               	<tr><td style='font-family:微軟正黑體;color:#000000;border: 2px dotted #666666;font-size:18px;padding:10px;' bgcolor=#F8F8FF colspan=5>釜山-DAY1(10/13)</td></tr>  
               	<tr><td colspan=5><script>showmap(1)</script></td></tr>  
               	<tr><td style='font-family:微軟正黑體;color:#000000;border: 2px dotted #666666;font-size:18px;padding:10px;' bgcolor=#F8F8FF colspan=5>釜山-DAY2(10/14)</td><tr>
               	<tr><td colspan=5><script>showmap(2)</script></td></tr>  
               	<tr><td style='font-family:微軟正黑體;color:#000000;border: 2px dotted #666666;font-size:18px;padding:10px;' bgcolor=#F8F8FF colspan=5>釜山-DAY3(10/15)</td></tr> 
               	<tr><td colspan=5><script>showmap(3)</script></td></tr>  
               	<tr><td style='font-family:微軟正黑體;color:#000000;border: 2px dotted #666666;font-size:18px;padding:10px;' bgcolor=#F8F8FF colspan=5>釜山-DAY4(10/16)</td></tr> 
               	<tr><td colspan=5><script>showmap(4)</script></td></tr>  
               	<tr><td style='font-family:微軟正黑體;color:#000000;border: 2px dotted #666666;font-size:18px;padding:10px;' bgcolor=#F8F8FF colspan=5>釜山-DAY5(10/17)</td></tr> 
               	<tr><td colspan=5><script>showmap(5)</script></td></tr> 
               	<tr><td style='font-family:微軟正黑體;color:#000000;border: 2px dotted #666666;font-size:18px;padding:10px;' bgcolor=#F8F8FF colspan=5>首爾-DAY6(10/18)</td></tr> 
               	<tr><td colspan=5><script>showmap(6)</script></td></tr> 
               	<tr><td style='font-family:微軟正黑體;color:#000000;border: 2px dotted #666666;font-size:18px;padding:10px;' bgcolor=#F8F8FF colspan=5>首爾-DAY7(10/19)</td></tr> 
               	<tr><td colspan=5><script>showmap(7)</script></td></tr> 
      	       </table>

      	  </div>  
      	  <div id="S2" style="display:none;">
      	    <form action="https://docs.google.com/forms/d/1V4mQsUWhAwOOFbnrnPBt9KgxgvKCpA6PwdUTH1Ka5rc/formResponse" id="form1" name="form1" target="actionframe">
      	    <!--<form action="https://docs.google.com/forms/d/1gHflobDAYlCL2Z92Mb5_nwVG_372DDtoJT2vVihKHqk/formResponse" id="form1" name="form1" target="actionframe">-->
      	      <table width=100% >
      	      	<tr><td bgcolor=#F79F81 colspan="2">景點資料輸入</td></tr> 
      	      	<tr>
      	      		<td bgcolor=#DDE2FD >地點名稱：</td>
      	      		<td>
      	    	      <input type="text" name="location" id="location" value=""   ><input type="text" name="chk1" id="chk1" value="" style="border-width:0px;font-size:16px;color:red" readonly >
      	    	      <input type="hidden" name="entry.855153958" value=""  id="entry_855153958" >
      	      		</td>
      	      	</tr><tr>
      	      		<td bgcolor=#DDE2FD >項次：</td>
      	      		<td>
      	      			<input type="text" name="seq" id="seq" value="" size="2"  style="border-width:0px;font-size:16px;" readonly >
      	      			<input type="hidden" name="entry.31602519"  value=""  id="entry_31602519" >
      	      		</td>
      	      	</tr><tr>
      	      		<td bgcolor=#DDE2FD >經度：</td>
      	      		<td>
      	      			<input type="text" name="lat" id="lat" value=""   >
      	      			<input type="hidden" name="entry.1757674640" value=""  id="entry_1757674640" >
      	      		</td>
      	      	</tr><tr>
      	      		<td bgcolor=#DDE2FD >緯度：</td>
      	      		<td>
      	      			<input type="text" name="lng" id="lng" value=""   >
      	      			<input type="hidden" name="entry.1690812210" value=""  id="entry_1690812210" >
      	      		</td>
      	      	</tr><tr>
      	      		<td bgcolor=#DDE2FD >備註：</td>
      	      		<td>
      	      			<input type="text" name="remark" id="remark" value=""   >
      	      			<input type="hidden" name="entry.24757726" value=""  id="entry_24757726" >
      	      		</td>
      	      	</tr><tr>
      	      		<td bgcolor=#DDE2FD >類別：</td>
      	      		<td>
      	      			<select name="tran" id="tran">
      	      				<option value = "A">景點</option>
      	      				<option value = "B">餐廳</option>
      	      			</select>
      	      			<input type="hidden" name="entry.892426724" value=""  id="entry_892426724" >
      	      		</td>
      	      	</tr><tr>
      	      		<td bgcolor=#DDE2FD >第幾天：</td>
      	      		<td>
      	      			<select name="kind" id="kind">
      	      				<option value = "">請選擇</option>
      	      				<option value = "1">DAY 1</option>
      	      				<option value = "2">DAY 2</option>
      	      				<option value = "3">DAY 3</option>
      	      				<option value = "4">DAY 4</option>
      	      				<option value = "5">DAY 5</option>
      	      				<option value = "6">DAY 6</option>
      	      				<option value = "7">DAY 7</option>
      	      			</select>
      	      			<input type="hidden" name="entry.1768868211" value=""  id="entry_1768868211" >
      	      		</td>
      	      	</tr>
      	      </table>
 		  	    	
      	    	<input type="button" name="button" id="button" value="&#25552;&#20132;" onClick="check()">
      	    </form>
      	    <iframe width="0" height="0" name="actionframe"></iframe>
      	  </div>  
      	</div>
      </div>
    </div>  

    <script type="text/javascript">
    
    	function check()
    	{
    		var error_message = '';
    		if(document.getElementById("location").value=='')
    		  error_message += '請輸入名稱; ';
    		if(document.getElementById("kind").value=='')
    		  error_message += '請輸入第幾天; ';
    		if(document.getElementById("lat").value=='')
    		  error_message += '請輸入經度; ';
    		if(document.getElementById("lng").value=='')
    		  error_message += '請輸入緯度; ';
    		
    		if(error_message.length>0)
    		{
    		  alert(error_message);	
    		  return false;
    		}else{
          document.getElementById("entry_855153958" ).value = document.getElementById("location").value;
          document.getElementById("entry_31602519"  ).value = document.getElementById("seq").value;
          document.getElementById("entry_1757674640").value = document.getElementById("lat").value;
          document.getElementById("entry_1690812210").value = document.getElementById("lng").value;
          document.getElementById("entry_892426724" ).value = document.getElementById("tran").value;
          document.getElementById("entry_24757726"  ).value = document.getElementById("remark").value;
          document.getElementById("entry_1768868211").value = document.getElementById("kind").value;
          document.getElementById("chk1").value ="已新增"+document.getElementById("location").value;
          document.getElementById("location").value='';
          document.getElementById("seq"   ).value='';     
          document.getElementById("lat"   ).value='';     
          document.getElementById("lng"   ).value='';     
          document.getElementById("tran"  ).value='';    
          document.getElementById("remark").value='';  
          document.getElementById("kind"  ).value='';
          //document.form1.submit();
          document.getElementById('form1').submit();
          
           myrefresh();
        }  
    	}
      function myrefresh()
      {
           setTimeout(function () {location.reload(); }, 1 * 1000);
      }
      function loadTab(obj,n)
      {
        var layer;
        eval('layer=\'S'+n+'\'');
      
        //將 Tab 標籤樣式設成 Blur 型態
        var tabsF=document.getElementById('tabsF').getElementsByTagName('li');
        for (var i=0;i<tabsF.length;i++){
            tabsF[i].setAttribute('id',null);
             eval('document.getElementById(\'S'+(i+1)+'\').style.display=\'none\'')
        }
      
        //變更分頁標題樣式
        obj.parentNode.setAttribute('id','current');
        document.getElementById(layer).style.display='inline';
      }
    
      function gotosearch()
      {
        var url="index.html";
        
        location.href=url+"?day_tag="+document.getElementById("day_tag").value
                              +"&eat_tag="+document.getElementById("eat_tag").value;
      }
    
    
    </script>

  </body>
</html>
